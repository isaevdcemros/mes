int main()
{
    HRESULT hr;

    hr = CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED);
    if (FAILED(hr)) return hr;

    hr = CoInitializeSecurity(
        nullptr,
        -1,
        nullptr,
        nullptr,
        RPC_C_AUTHN_LEVEL_CONNECT,
        RPC_C_IMP_LEVEL_IMPERSONATE,
        nullptr,
        EOAC_NONE,
        nullptr
    );
    if (FAILED(hr)) return hr;

    IOPCServer* pServer = nullptr;

    hr = CoCreateInstance(
        clsidOPC,
        nullptr,
        CLSCTX_LOCAL_SERVER,
        IID_IOPCServer,
        (void**)&pServer
    );
    if (FAILED(hr)) return hr;

    DWORD groupHandle = 0;
    IOPCItemMgt* pItemMgt = nullptr;

    hr = pServer->AddGroup(
        L"TestGroup",
        TRUE,
        1000,
        1,
        nullptr,
        nullptr,
        LOCALE_ID,
        &groupHandle,
        nullptr,
        IID_IOPCItemMgt,
        (LPUNKNOWN*)&pItemMgt
    );
    if (FAILED(hr)) return hr;

    OPCITEMDEF items[1] = {};
    items[0].szItemID = L"Random.Int1";
    items[0].bActive = TRUE;
    items[0].hClient = 1;
    items[0].vtRequestedDataType = VT_I4;

    OPCITEMRESULT* pResults = nullptr;
    HRESULT* pErrors = nullptr;

    hr = pItemMgt->AddItems(1, items, &pResults, &pErrors);
    if (FAILED(hr)) return hr;

    IOPCSyncIO* pSyncIO = nullptr;
    hr = pItemMgt->QueryInterface(IID_IOPCSyncIO, (void**)&pSyncIO);
    if (FAILED(hr)) return hr;

    OPCITEMSTATE* pStates = nullptr;
    hr = pSyncIO->Read(OPC_DS_DEVICE, 1, &pResults[0].hServer, &pStates, &pErrors);
    if (SUCCEEDED(hr))
    {
        std::wcout << L"Value: " << pStates[0].vDataValue.lVal << std::endl;
    }

    // cleanup
    pSyncIO->Release();
    pItemMgt->Release();
    pServer->Release();
    CoUninitialize();

    return 0;
}